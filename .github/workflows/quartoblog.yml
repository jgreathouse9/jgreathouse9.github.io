name: Quarto Blog

on:
  push:
    paths:
      - 'qdocs/**'  # Trigger on any file change within the qdocs directory
  workflow_dispatch:
    inputs:
      qmd_path:
        description: "Optional: Path to a specific .qmd file to render (e.g. qdocs/posts/my-post.qmd)"
        required: false
        default: ""

jobs:
  render:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.13'

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        version: "1.7.8"

    - name: Install required Python packages
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r qdocs/requirements.txt

    - name: Conditionally Remove docs/ Directory
      run: |
        if [ -z "${{ github.event.inputs.qmd_path }}" ]; then
          echo "Rendering all files. Removing existing docs/ directory..."
          if [ -d docs ]; then rm -rf docs; fi
        else
          echo "Rendering single file only. Keeping existing docs/ directory."
        fi

    - name: Conditionally Generate index.qmd
      run: |
        if [ -z "${{ github.event.inputs.qmd_path }}" ]; then
          echo "---" > qdocs/index.qmd
          echo "format: html" >> qdocs/index.qmd
          echo "---" >> qdocs/index.qmd
          echo "" >> qdocs/index.qmd
          echo "Here are my blog posts that cover causal inference, econometrics, machine learning, and other data science topics." >> qdocs/index.qmd
          echo "" >> qdocs/index.qmd
        fi

    - name: Conditionally Render Quarto File(s)
      run: |
        if [ -n "${{ github.event.inputs.qmd_path }}" ]; then
          echo "Rendering only: ${{ github.event.inputs.qmd_path }}"
          quarto render "${{ github.event.inputs.qmd_path }}"
        else
          echo "Rendering all .qmd files in qdocs/"
          for file in qdocs/*.qmd; do
            echo "Rendering $file..."
            quarto render "$file"
          done
        fi

    - name: Check rendered output
      run: ls -l docs/

    - name: Commit rendered output
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # Add only changed files in docs/
        git add -u docs/

        # Commit if there are changes
        if ! git diff --cached --quiet; then
          if [ -n "${{ github.event.inputs.qmd_path }}" ]; then
            git commit -m "Render Quarto site for updated file ${{ github.event.inputs.qmd_path }}"
          else
            git commit -m "Render Quarto site with updated index and all posts"
          fi
          git push
        else
          echo "No changes to commit."
        fi
