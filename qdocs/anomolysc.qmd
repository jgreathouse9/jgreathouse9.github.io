---
title: "AnomalyDetection SC"
date: 2025-05-01
categories: [Causal Inference, Econometrics]
---

To construct a robust synthetic control, we begin by pre-processing the data. For each control unit $j \in \mathcal{N}_0$, we define the normalized and detrended time series $\tilde{\mathbf{y}}_j \in \mathbb{R}^T$ by subtracting the mean over time: $\tilde{\mathbf{y}}_j = \mathbf{y}_j - \frac{1}{T} \sum_{t \in \mathcal{T}} y_{j,t}$. The treated unit $\mathbf{y}_1$ is normalized similarly. Let $\tilde{\mathbf{Y}}_0 \in \mathbb{R}^{T \times N_0}$ denote the matrix that stacks the $\tilde{\mathbf{y}}_j$ for all $j \in \mathcal{N}_0$.

Next, we perform anomaly detection using two tests on the pre-treatment data $\mathcal{T}_1 = \{1, \dots, T_0\}$. The first is a Granger causality test, in which we regress $\tilde{y}_{1,t}$ on lagged values of $\tilde{y}_{j,t-1}$ and retain control unit $j$ only if the null hypothesis of no Granger causality is rejected at significance level $\alpha$. We define a binary indicator $g_j \in \{0, 1\}$ which equals $1$ if control $j$ passes the Granger test and $0$ otherwise.

The second test is a proximity test, which measures how far each control unit's trajectory deviates from the average of the other control units. Let $\bar{\tilde{\mathbf{y}}}_{-j}^{\text{pre}} = \frac{1}{N_0 - 1} \sum_{k \neq j} \tilde{\mathbf{y}}_k^{\text{pre}}$ denote the average pre-treatment path excluding unit $j$, and define the squared distance $d_j = \frac{1}{T_0} \left\| \tilde{\mathbf{y}}_j^{\text{pre}} - \bar{\tilde{\mathbf{y}}}_{-j}^{\text{pre}} \right\|_2^2$. If $d_j$ exceeds the $(1 - \alpha)$ quantile of the chi-squared distribution with $T_0$ degrees of freedom, we flag control $j$ as an anomaly. Let $p_j \in \{0, 1\}$ be the indicator of whether unit $j$ passes this proximity test.

The hybrid approach combines these two diagnostics. We define the inclusion indicator $I_j = g_j \cdot p_j$, which equals $1$ if donor $j$ passes both tests and $0$ otherwise. For each unit $j$, we compute a soft anomaly score $s_j = \exp\left(-\frac{d_j^2}{2\sigma^2} \right)$, where $\sigma > 0$ controls the sensitivity of the weighting to distance anomalies. These scores are not used to directly define synthetic control weights; instead, they are used to define importance weights in the estimation process.

Let $\mathbf{W} \in \mathbb{R}^{N_0 \times N_0}$ be the diagonal matrix with entries $w_j = I_j \cdot s_j$. These weights are incorporated into a re-weighted loss function used to estimate the parameters of a latent factor model for the control units. Specifically, we solve the following optimization problem.
