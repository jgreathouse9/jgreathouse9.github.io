<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Forward Difference in Differences for Stata Users</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="StataVignette_files/libs/clipboard/clipboard.min.js"></script>
<script src="StataVignette_files/libs/quarto-html/quarto.js"></script>
<script src="StataVignette_files/libs/quarto-html/popper.min.js"></script>
<script src="StataVignette_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="StataVignette_files/libs/quarto-html/anchor.min.js"></script>
<link href="StataVignette_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="StataVignette_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="StataVignette_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="StataVignette_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="StataVignette_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Forward Difference in Differences for Stata Users</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="intro-to-fdid" class="level1">
<h1>Intro to <code>fdid</code></h1>
<p>Here, I cover the forward selection difference-in-differences method for Stata. Note that I already do the equivalent in <a href="https://github.com/jgreathouse9/FDIDTutorial/blob/main/Vignette.md">the Python vignette</a>. So, I will but briefly restate the algorithm and the basic ideas. For the more technical treatment, see <a href="https://jgreathouse9.github.io/publications/FDIDSJ.pdf">my paper</a>. This vignette demonstrates how to use FDID for Stata 16 and up. Users need <code>sdid_event</code> to be <a href="https://github.com/DiegoCiccia/sdid/tree/main/sdid_event#github">installed</a>.</p>
<p>First we install <code>fdid</code> and its help file into Stata like</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>net inst fdid, from(<span class="st">"https://raw.githubusercontent.com/jgreathouse9/FDIDTutorial/main"</span>) <span class="kw">replace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can get the datasets I include like</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>net <span class="fu">get</span> fdid, <span class="ot">all</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-model" class="level1">
<h1>The Model</h1>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>We observe <span class="math inline">\(\mathcal{N} = \{1, 2, \ldots, N\}\)</span> units where <span class="math inline">\(\mathcal N\)</span> has cardinality <span class="math inline">\(N = |\mathcal{N}|\)</span>. <span class="math inline">\(j=1\)</span> is treated and controls are <span class="math inline">\(\mathcal{N}_0 = \mathcal{N} \setminus \{1\}\)</span>. Time is indexed by <span class="math inline">\(t\)</span>. Denote pre-post-policy periods as <span class="math inline">\(\mathcal{T}_1 = \{1, 2, \ldots, T_0\}\)</span> and <span class="math inline">\(\mathcal{T}_2 = \{T_0+1, \ldots, T\}\)</span>, where <span class="math inline">\(\mathcal{T}= \mathcal{T}_1 \cup \mathcal{T}_2\)</span>. The subset of controls we wish to select are <span class="math inline">\(\widehat{U} \subset \mathcal{N}_0\)</span>, or the subset of controls. DiD is estimated like <span class="math inline">\(y_{1t}=\hat\alpha_{\mathcal{N}_0}+ \bar{y}_{\mathcal{N}_0t} \: t \in \mathcal{T}_1\)</span>, where <span class="math inline">\(\bar{y}_{\mathcal{N}_0t}\coloneqq \frac{1}{N_0} \sum_{j \in \mathcal{N}_0} y_{jt}\)</span>. The estimated least-squares intercept is computed like <span class="math inline">\(\hat\alpha_{\mathcal{N}_0} \coloneqq T_{1}^{-1}\sum_{t \in \mathcal{T}_{1}}\left(y_{1t}-\bar{y}_{\mathcal{N}_0t}\right)\)</span>.</p>
</section>
<section id="the-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="the-algorithm">The Algorithm</h2>
<p>Basically, <code>fdid</code> uses a forward selection algorithm to choose the optimal control group for a single treated unit. Each control unit is used in bivariate linear regression models to choose the best control units. We choose the ideal control from each iteration, and add it to the next set of predictors, choosing the best control from that iteration plus the already selected units. Below I paraphrase from my paper:</p>
<blockquote class="blockquote">
<p>Let <span class="math inline">\(\mathcal{N}_0 = \{i_1 \text{ (Chicago)}, i_2 \text{ (Miami)}, i_3 \text{ (Phoenix)}\}\)</span> be the controls for a generic treated unit. For <span class="math inline">\(k=1\)</span>, we estimate DiD for each control unit in <span class="math inline">\(\mathcal{N}_0\)</span> individually, yielding pre-treatment <span class="math inline">\(R^2_{ik}\)</span> values: <span class="math inline">\(R^2_{1,1} = 0.60\)</span>, <span class="math inline">\(R^2_{2,1} = 0.50\)</span>, and <span class="math inline">\(R^2_{3,1} = 0.23\)</span>. Since <span class="math inline">\(R^2_{1,1} = 0.60\)</span> is the highest, we update the control set to <span class="math inline">\(\widehat{U}_1 = \{i_1\}\)</span> and <span class="math inline">\(R_k^{2}=0.60\)</span>. This is the first candidate model. For <span class="math inline">\(k=2\)</span>, we estimate two DiD models using <span class="math inline">\(i_1\)</span> with the remaining controls from <span class="math inline">\(\{i_2, i_3\}\)</span>, yielding <span class="math inline">\(R^2_{2,2} = 0.88\)</span> and <span class="math inline">\(R^2_{3,2} = 0.68\)</span>. We select <span class="math inline">\(i_2\)</span> (Miami) and update the control set to <span class="math inline">\(\widehat{U}_2 = \{i_1, i_2\}\)</span> since <span class="math inline">\(R^2_{2,2} = 0.88\)</span> is the highest. This is the second candidate model. For <span class="math inline">\(k=3\)</span>, using all controls, we get <span class="math inline">\(R^2_{3,3} = 0.55\)</span>. This is the third candidate model. The final control set is <span class="math inline">\(\widehat{U}_2 = \{i_1, i_2\}\)</span>, as <span class="math inline">\(\operatorname*{max}_k R^2_k = 0.88\)</span>, as this is the canddiate model with the highest R-squared.</p>
</blockquote>
<p>Post-selection, estimates FDID like <span class="math display">\[
y_{1t}=\hat\alpha_{\widehat{U}}+ \bar{y}_{\widehat{U}t} \quad t \in \mathcal{T}_1
\label{eq:DiD}
\]</span> where we now exchange <span class="math inline">\(\mathcal{N}_0\)</span> for <span class="math inline">\(\widehat{U}\)</span>. Denote the FDID predictions as <span class="math inline">\(\hat{y}_{1t}^{0}=\hat\alpha_{\widehat{U}}+ \bar{y}_{\widehat{U}t}\)</span>, where the pre-treatment periods corresponds to the in-sample fit and the opposite denotes the out-of-sample counterfactual. Our causal estimand is: <span class="math inline">\(\widehat{ATT}_{\widehat{U}} = \frac{1}{T_2} \sum_{t \in \mathcal{T}_2} \left(y_{1t} - \hat{y}_{1t}^0\right)\)</span>, or the average treatment effect on the treated.</p>
</section>
</section>
<section id="hcw" class="level1">
<h1>HCW</h1>
<p>We can use <a href="https://doi.org/10.1002/jae.1230">the HCW dataset</a> to demonstrate <code>fdid</code>. We begin by importing the data</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>u <span class="st">"hcw.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, we study the impact of Hong Kong’s <a href="https://www.henleyglobal.com/residence-investment/hong-kong/cepa-hong-kong-china">economic integreation</a>. First, we can do <code>xtdescribe</code>, which produces the output</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>      id:  1, 2, ..., 25                                     n =         25</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    time:  1, 2, ..., 61                                     T =         61</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>           Delta(time) = 1 unit</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>           Span(time)  = 61 periods</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>           (id*time uniquely identifies each observation)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>Distribution <span class="kw">of</span> T_i:   <span class="fu">min</span>      5%     25%       50%       75%     95%     <span class="fu">max</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                        61      61      61        61        61      61      61</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>     Freq.  Percent    Cum. |  Pattern</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a> ---------------------------+---------------------------------------------------------------</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>       25    100.00  100.00 |  1111111111111111111111111111111111111111111111111111111111111</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a> ---------------------------+---------------------------------------------------------------</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>       25    100.00         |  XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We see that <span class="math inline">\(T=61\)</span>. When we do <code>list if treat==1</code>, we get the output</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>time      state    gdp   id   treat   polint  </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>      45   hongkong   .077    9       1        1  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>      46   hongkong    .12    9       1        1  </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      47   hongkong   .066    9       1        1  </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      48   hongkong   .079    9       1        1  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      49   hongkong   .062    9       1        1  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      50   hongkong   .071    9       1        1  </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      51   hongkong   .081    9       1        1  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      52   hongkong   .069    9       1        1  </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      53   hongkong    .09    9       1        1  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      54   hongkong   .062    9       1        1  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      55   hongkong   .064    9       1        1  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      56   hongkong   .066    9       1        1  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      57   hongkong   .055    9       1        1  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      58   hongkong   .062    9       1        1  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      59   hongkong   .068    9       1        1  </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      60   hongkong   .069    9       1        1  </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      61   hongkong   .073    9       1        1  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We have 44 pretreatment periods and 17 post-treatment periods. Our goal is to estimate the impact for those final 17 periods. From the <code>xtdescribe</code> output, we see that we have 24 control units. To estimate <code>fdid</code>, we simply do</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fdid gdp, tr(treat) unitnames(state) gr1opts(<span class="bn">title</span>(FDID Results))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We specify the outcome of interest as <code>gdp</code> and we specify the treatment as <code>treat</code>. We use the strings of the <code>state</code> variable to define the names of our units, sicne they are strings. This syntax produces the table</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Forward Difference-<span class="kw">in</span>-Differences   |    T0 R2: 0.843  T0 RMSE: 0.016</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>         gdp |     ATT     Std. Err.     t      P&gt;|t|    [95% Conf. Interval]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------------</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>       treat |   0.02540    0.00462     5.49    0.000     0.01634     0.03447</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>Treated Unit: hongkong</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>FDID selects philippines, singapore, thailand, norway, mexico, korea, indonesia, newzealand, malaysia, <span class="kw">as</span> the optimal donors.</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>See Li (2024) <span class="kw">for</span> technical details.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Pleasingly, these are the exact same results Kathy gets in her MATLAB code. Here is the plot:
<p align="center">
<img src="fithongkong.png" alt="Alt Text" width="100%" height="50%">
</p>
<p>If we wish to see the returned results, we can do</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ereturn</span> <span class="ot">list</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>macros:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">e</span>(U) : <span class="st">"philippines, singapore, thailand, norway, mexico, korea, indonesia, newzealand, malaysia,"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">e</span>(properties) : <span class="st">"b V"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>             <span class="fu">e</span>(depvar) : <span class="st">"gdp"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>matrices:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">e</span>(b) :  1 x 1</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">e</span>(<span class="kw">V</span>) :  1 x 1</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>             <span class="fu">e</span>(series) :  61 x 9</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">e</span>(setting) :  1 x 6</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">e</span>(results) :  2 x 7</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>             <span class="fu">e</span>(dyneff) :  61 x 6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>e(series)</code> is a matrix containing the observed and counterfactual values, event time, individual treatment effects. Naturally, the other statistics pertain to the total number of controls, the number of controls selected, as well as inferential statistics.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">l</span> <span class="fu">e</span>(results)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">e</span>(results)[2,7]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            ATT       PATT         <span class="kw">SE</span>          t         LB         UB         R2</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>FDID  .02540494  53.843074  .00462405  5.4940862  .01634196  .03446791   .8427835</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a> DID  .03172116    77.6203  .00298081  10.641796  .02556907  .03787324      .5046</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here DID uses the robust standard error as estimated by <code>xtdidregress</code>. We can clearly see that the pre-intervention <span class="math inline">\(R^2\)</span> for the selected control group of FDID is much higher than the DID method, suggesting that the parallel trends assumption for Forward DID holds compared to when we use all controls, as DID does.</p>
</section>
<section id="proposition-99" class="level1">
<h1>Proposition 99</h1>
<p>Next, I’d like to replicate one of the more classic papers in synthetic control methods, the case of Proposition 99 for California. Prop 99 was an anti-tobacco campaign that sought to reduce the rate of smoking in the population via education, awareness, and taxation. To run this, we do</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> *</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>cls</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>u <span class="st">"smoking.dta"</span>, <span class="kw">clear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When we do <code>xtdescribe</code>, we get</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>      id:  1, 2, ..., 39                                     n =         39</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">year</span>:  1970, 1971, ..., 2000                             T =         31</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>           Delta(<span class="fu">year</span>) = 1 <span class="fu">year</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>           Span(<span class="fu">year</span>)  = 31 periods</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>           (id*<span class="fu">year</span> uniquely identifies each observation)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>Distribution <span class="kw">of</span> T_i:   <span class="fu">min</span>      5%     25%       50%       75%     95%     <span class="fu">max</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                        31      31      31        31        31      31      31</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>     Freq.  Percent    Cum. |  Pattern</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a> ---------------------------+---------------------------------</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>       39    100.00  100.00 |  1111111111111111111111111111111</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a> ---------------------------+---------------------------------</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>       39    100.00         |  XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can see we have 38 controls. <code>list if treat==1</code> returns the output</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>         state   <span class="fu">year</span>   cigsale   lnincome   beer   age15~24   retprice   treated   id  </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    California   1989      82.4   10.14231   23.7   .1535246      126.4         1    3  </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    California   1990      77.8   10.14162   23.8    .149523      163.8         1    3  </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    California   1991      68.7   10.11071   22.3          .      186.8         1    3  </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    California   1992      67.5   10.11494   21.3          .      201.9         1    3  </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    California   1993      63.4    10.0985   20.8          .      205.1         1    3  </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    California   1994      58.6   10.09951   20.1          .      190.3         1    3  </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    California   1995      56.4   10.15592   19.7          .      195.1         1    3  </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    California   1996      54.5   10.17864   19.1          .      197.9         1    3  </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    California   1997      53.8   10.17519   19.5          .      200.3         1    3  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    California   1998      52.3          .      .          .      207.8         1    3  </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    California   1999      47.2          .      .          .      224.9         1    3  </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    California   2000      41.6          .      .          .      351.2         1    3  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can see that treatment begins in 1989, continuing until the end of the study period. We estimate the effect like</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fdid cigsale, tr(treated) unitnames(state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which returns the table</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>Forward Difference-<span class="kw">in</span>-Differences          T0 R2:     0.988     T0 RMSE:     1.282</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------------------</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>     cigsale |     ATT       Std. Err.      t       P&gt;|t|    [95% Conf. Interval]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------------------------</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>     treated | -13.64671     0.46016      29.66     0.000    -14.54861  -12.74481</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------------------</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>Treated Unit: California</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>FDID selects Montana, Colorado, Nevada, Connecticut, <span class="kw">as</span> the optimal donors.</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>See Li (2024) <span class="kw">for</span> technical details.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With these results, we may produce the plot</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">svmat</span> <span class="fu">e</span>(series), names(col)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">tsset</span> <span class="fu">year</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> cigsale3 <span class="st">"California"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> cf3 <span class="st">"FDID"</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> cfdd3 <span class="st">"DID"</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> ymeandid <span class="st">"DID Control Mean"</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> ymeanfdid <span class="st">"FDID Control Mean"</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>lab <span class="kw">var</span> <span class="fu">year</span> <span class="st">"Year"</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="kw">twoway</span> (<span class="kw">tsline</span> cigsale3) <span class="co">///</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">tsline</span> cfdd3, lcolor(<span class="bn">black</span>) lwidth(thick) lpattern(<span class="kw">dash</span>)) <span class="co">///</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">tsline</span> ymeandid, lcolor(<span class="bn">black</span>) lwidth(thick) lpattern(solid)), <span class="co">///</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="dv">scheme</span>(sj) <span class="bn">name</span>(did, <span class="kw">replace</span>) <span class="co">///</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>yti(Cigarette Consumption per Capita) tli(1989) <span class="bn">legend</span>(<span class="bn">ring</span>(0) pos(7) col(1) <span class="kw">size</span>(large)) <span class="co">///</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>ti(Uses <span class="ot">all</span> controls)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="kw">twoway</span> (<span class="kw">tsline</span> cigsale3) <span class="co">///</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>(<span class="kw">tsline</span> cf3,lcolor(gs6) lwidth(thick) lpattern(longdash)) <span class="co">///</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>(<span class="kw">tsline</span> ymeanfdid, lcolor(gs6) lwidth(thick) lpattern(solid)), <span class="co">///</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="dv">scheme</span>(sj) <span class="bn">name</span>(fdid, <span class="kw">replace</span>) tli(1989) <span class="bn">legend</span>(<span class="bn">ring</span>(0) pos(7) col(1) <span class="kw">size</span>(large)) <span class="co">///</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>ti(Uses 4 controls)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="kw">graph</span> <span class="bn">combine</span> did fdid, <span class="bn">xsize</span>(8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p align="center">
<img src="FDIDP99Update.png" alt="Alt Text" width="100%" height="50%">
</p>
<p>The R-squared of DID here is 0.604, versus FDID’s R-squared of 0.988. This naturally has real implications for the analysis’ findings. Because the fit for DID in the pre-intervention period is so poor (as a result of non-parallel trends holding across all control units), the DID method badly overestimates the causal effect, returning an ATT of -27.349.</p>
<p>FDID’s control group seems much more parallel to the pre-treatment trend of California. Its pre-intervention R-squared is higher than DID, meaning that the parallel trends assumption is much more likely to hold for FDID in this instance relative to DID. The effect sizes also differ, with FDID returning an ATT of -13.647.</p>
<p>To put this another way, the ATT of FDID is basically half of the DID estimate due to parallel trends bias from the original DID method. This is a colossal reduction of effect. Also of interest is that FDID selects 4 control states which happen to be the exact same states as the original synthetic control method selected. On top of this, we can also see that FDID gets these results without needing to use retail price of cigarettes, age, income, taxation, and outcome lags to attain what is essentially the same results of other synthetic control methods (<a href="https://rpubs.com/dwrich27/941298">which tend to vary</a> between -13 and -19, depending on which <a href="https://doi.org/10.48550/arXiv.2203.11576">flavor</a> of SCM we use).</p>
<p>Of course, FDID assumes that a uniformly weighted average is the ideal way to model the counterfactual, but the point here is that we can get very similar results to the findings of the original model using a relatively simpler estimator which also happens to be qualitatively similar. An added benefit of DID is that inference is more straightforward compared to synthetic controls. In the staggered adoption case, we simply estimate one ATT per treated unit (using the never treated units as controls) and average the effect sizes together. Okay, so that’s it for the vignette. No doubt people will have questions, suggestions, ideas, or errors to report, concerns, so you may contact me as ususal.</p>
</section>
<section id="contact" class="level1">
<h1>Contact</h1>
<ul>
<li>Jared Greathouse: <a href="mailto:jgreathouse3@student.gsu.edu" class="email">jgreathouse3@student.gsu.edu</a> (see <a href="https://jgreathouse9.github.io/">my website</a>)</li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>