---
title: "AnomalyDetection SC"
date: 2025-05-01
categories: [Causal Inference, Econometrics]
---

To construct a robust synthetic control, we begin by pre-processing the data. For each control unit $j \in \mathcal{N}_0$, we define the normalized and detrended time series $\tilde{\mathbf{y}}_j \in \mathbb{R}^T$ by subtracting the mean over time: $\tilde{\mathbf{y}}_j = \mathbf{y}_j - \frac{1}{T} \sum_{t \in \mathcal{T}} y_{j,t}$. The treated unit $\mathbf{y}_1$ is normalized similarly. Let $\tilde{\mathbf{Y}}_0 \in \mathbb{R}^{T \times N_0}$ denote the matrix that stacks the $\tilde{\mathbf{y}}_j$ for all $j \in \mathcal{N}_0$.

Next, we perform anomaly detection using two tests on the pre-treatment data $\mathcal{T}_1 = \{1, \dots, T_0\}$. The first test is a Granger causality test, where we regress $\tilde{y}_{1,t}$ on lagged values of $\tilde{y}_{j,t-1}$ and retain control unit $j$ only if the null hypothesis of no Granger causality is rejected at significance level $\alpha$. We define a binary indicator $g_j \in \{0, 1\}$ which equals $1$ if control $j$ passes the Granger test and $0$ otherwise.

The second test is a proximity test, which measures how far each control unit's trajectory deviates from the average of the other control units. Let $\bar{\tilde{\mathbf{y}}}_{-j}^{\text{pre}} = \frac{1}{N_0 - 1} \sum_{k \neq j} \tilde{\mathbf{y}}_k^{\text{pre}}$ denote the average pre-treatment path excluding unit $j$, and define the squared distance $d_j = \frac{1}{T_0} \| \tilde{\mathbf{y}}_j^{\text{pre}} - \bar{\tilde{\mathbf{y}}}_{-j}^{\text{pre}} \|_2^2$. If $d_j$ exceeds the $(1 - \alpha)$ quantile of a chi-squared distribution with $T_0$ degrees of freedom, we flag control $j$ as an anomaly. Let $p_j \in \{0, 1\}$ be the indicator of whether unit $j$ passes this proximity test.

We then define a hybrid mask $I_j = g_j \cdot p_j$ which equals $1$ if control $j$ passes both tests and $0$ otherwise. For those units with $I_j = 1$, we compute a soft anomaly score using a Gaussian radial basis function: $s_j = \exp\left( -\frac{d_j^2}{2\sigma^2} \right)$, where $\sigma > 0$ controls the smoothness of the weighting. The final hybrid weights are then defined as $w_j = \frac{I_j \cdot s_j}{\sum_{k \in \mathcal{N}_0} I_k \cdot s_k}$, so that the weight vector $\mathbf{w} = [w_j]_{j \in \mathcal{N}_0}$ lies in the probability simplex $\Delta^{N_0 - 1}$, and assigns zero weight to anomalous donors.

These weights can then be used to compute the synthetic control as a convex combination of the retained control units: $\hat{\mathbf{y}}_1 = \mathbf{Y}_0 \mathbf{w}$.
